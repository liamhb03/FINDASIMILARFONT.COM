<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Walkie-Talkie via QR (WebRTC)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    #qrcode, #scanAnswerQR { margin-top: 1em; }
    textarea { width: 100%; height: 100px; }
    button { padding: 0.5em 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>Walkie-Talkie via QR</h2>
  <button onclick="startOffer()">Create Offer (Show QR)</button>
  <div id="qrcode"></div>

  <h3>Paste Answer (from QR or manually)</h3>
  <textarea id="answerInput" placeholder="Paste answer here..."></textarea>
  <button onclick="submitAnswer()">Submit Answer</button>

  <h3>Hold to Talk</h3>
  <button id="talkBtn" disabled>Hold to Talk</button>

  <script>
    let localConnection, remoteStream, localStream;

    async function startOffer() {
      localConnection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => localConnection.addTrack(track, localStream));

      const offer = await localConnection.createOffer();
      await localConnection.setLocalDescription(offer);

      localConnection.onicecandidate = () => {
        if (localConnection.iceGatheringState === 'complete') {
          const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(localConnection.localDescription));
          document.getElementById('qrcode').innerHTML = '';
          new QRCode(document.getElementById('qrcode'), {
            text: compressed,
            width: 256,
            height: 256
          });
        }
      };
    }

    async function submitAnswer() {
      const compressed = document.getElementById('answerInput').value.trim();
      if (!compressed) return alert('Please paste an answer');
      const answer = JSON.parse(LZString.decompressFromEncodedURIComponent(compressed));
      await localConnection.setRemoteDescription(answer);

      localConnection.ontrack = (event) => {
        remoteStream = event.streams[0];
        const audio = new Audio();
        audio.srcObject = remoteStream;
        audio.play();
        document.getElementById('talkBtn').disabled = false;
      };

      setupTalkButton();
    }

    function setupTalkButton() {
      const btn = document.getElementById('talkBtn');
      btn.addEventListener('mousedown', () => {
        localStream.getAudioTracks()[0].enabled = true;
      });
      btn.addEventListener('mouseup', () => {
        localStream.getAudioTracks()[0].enabled = false;
      });
      localStream.getAudioTracks()[0].enabled = false;
    }
  </script>
</body>
</html>
